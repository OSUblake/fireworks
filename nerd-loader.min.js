class NerdLoader{constructor(){this.scriptElements=Array.from(document.querySelectorAll("script")),this.mediaElements=Array.from(document.querySelectorAll("video, audio"))}async load(resources){await Promise.all(resources.scripts.map(url=>this.loadScript(url))),gsap.globalTimeline.getChildren().forEach(animation=>animation.kill());const emoteUrls=resources.emotes.filter(url=>!!url),[emotes,sounds]=await Promise.all([this.loadAssets([...emoteUrls,...emoteUrls]),Promise.all(resources.sounds.map(url=>this.loadSound(url))),Promise.all(this.mediaElements.map(element=>this.loadMedia(element.currentSrc,element)))]);return{emotes:emotes,sounds:sounds}}loadAssets(assets){const promises=assets.reduce((res,asset)=>{let promise;return this.imageUrl(asset)?promise=this.loadImage(asset):this.videoUrl(asset)&&(promise=this.loadMedia(asset)),promise&&res.push(promise),res},[]);return Promise.all(promises)}loadImage(url){return new Promise(async(resolve,reject)=>{const cachedUrl=await this.checkCache(url),imageElement=new Image;function fulfill(){imageElement.onload=null,imageElement.onerror=null,resolve(imageElement)}imageElement.crossOrigin="Anonymous",imageElement.src=cachedUrl,imageElement.complete?resolve(imageElement):(imageElement.onload=fulfill,imageElement.onerror=fulfill)})}loadMedia(url,element){return new Promise(async(resolve,reject)=>{const cachedUrl=await this.checkCache(url),mediaElement=element||document.createElement("video");function fulfill(){return mediaElement.oncanplaythrough=null,mediaElement.onerror=null,resolve(mediaElement)}mediaElement.muted=!0,mediaElement.crossOrigin="Anonymous",mediaElement.src=cachedUrl,mediaElement.readyState>3?resolve(mediaElement):(mediaElement.oncanplaythrough=fulfill,mediaElement.onerror=fulfill)})}loadScript(url){return new Promise(async(resolve,reject)=>{const cachedUrl=await this.checkCache(url),exists=scriptElements.some(scriptElement=>scriptElement.src===cachedUrl);if(exists)return resolve();const script=document.createElement("script");function fulfill(){script.onload=null,script.onerror=null,resolve(script)}document.head.appendChild(script),script.onerror=fulfill,script.onload=fulfill,script.src=cachedUrl})}loadSound(url){return new Promise(async(resolve,reject)=>{const cachedUrl=await this.checkCache(url),sound=new Howl({src:cachedUrl,autoplay:!1,mute:!0,onloaderror:()=>resolve(sound),onload:()=>resolve(sound)})})}videoUrl(image){return image.match(/\.(3gp|mpg|mpeg|mp4|m4v|m4p|ogv|ogg|mov|webm)$/)}imageUrl(image){return image.match(/\.(jpeg|jpg|gif|png|svg|webp)$/)}checkCache(url){return new Promise((resolve,reject)=>{console.log("*** Checking cache url",url),fetch(url).then(()=>resolve(url)).catch(()=>{if(-1!==url.indexOf("nocache"))return reject("Nocache failed");resolve(this.checkCache(`${url}?_nocache=${this.uniqueID()}`))})})}uniqueID(){return Date.now()+Math.random().toString(16).slice(2)}loadScript(url){return new Promise(async(resolve,reject)=>{const exists=this.scriptElements.some(scriptElement=>scriptElement.src===url);if(exists)return resolve();const script=document.createElement("script");document.head.appendChild(script),script.onerror=reject,script.onload=resolve,script.src=url})}static async load(resources){const loader=new NerdLoader;return loader.load(resources)}}